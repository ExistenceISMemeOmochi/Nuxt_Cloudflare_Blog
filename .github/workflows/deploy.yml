name: Deploy Nuxt Blog to Cloudflare Pages - Dist

# ä»¥ä¸‹ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã—ãŸã¨ãã«ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œ
on:
  push:
    branches: [ main ] # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥æ™‚

# --------------------------
# 1. build ã‚¸ãƒ§ãƒ– (CIã¨ãƒ“ãƒ«ãƒ‰)
# --------------------------
jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      # Nuxtã®ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œ (ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã«ã‚ˆã‚Šã€å‡ºåŠ›ã¯ dist/ ã«ãªã‚‹ã“ã¨ã‚’æƒ³å®š)
      - name: Build Nuxt Application
        run: npm run build
        
      # ãƒ“ãƒ«ãƒ‰æˆæœç‰© (é™çš„ãƒ•ã‚¡ã‚¤ãƒ«) ã‚’æ¬¡ã®ã‚¸ãƒ§ãƒ–ã«å¼•ãæ¸¡ã™ãŸã‚ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nuxt-dist
          path: dist # ğŸ’¡ ã“ã“ã‚’ 'dist' ã«å¤‰æ›´
          retention-days: 1

  # --------------------------
  # 2. deploy ã‚¸ãƒ§ãƒ–
  # --------------------------
  deploy:
    runs-on: ubuntu-latest
    needs: build 
    
    steps:
      # buildã‚¸ãƒ§ãƒ–ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸæˆæœç‰©ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: nuxt-dist
          path: dist # ğŸ’¡ ã“ã“ã‚’ 'dist' ã«å¤‰æ›´

      # Cloudflare Pagesã¸ãƒ‡ãƒ—ãƒ­ã‚¤
      - name: Publish to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: nuxt-cloudflare-blog
          directory: dist # ğŸ’¡ ã“ã“ã‚’ 'dist' ã«å¤‰æ›´
          # branch: ${{ github.ref_name }} # å¿…è¦ã«å¿œã˜ã¦ãƒ–ãƒ©ãƒ³ãƒæŒ‡å®š